<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Users – Enterprise Permissions Demo</title>
  <style>
    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:#f5f6f8;
      margin:0;
      padding:24px;
      color:#111827;
    }

    .modal {
      max-width:1100px;
      margin:auto;
      background:#fff;
      border-radius:10px;
      box-shadow:0 20px 40px rgba(0,0,0,.12);
      overflow:hidden;
      height: calc(100vh - 50px);
      display:flex;
      flex-direction:column;
    }

    .header {
      padding:20px 24px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    h1 { font-size:20px; margin:0; }
    .content { padding:24px; flex: 1 1 auto; overflow: auto; min-height: 0; }
    .section { margin-bottom:28px; }

    .section h2 { font-size:16px; margin:0 0 4px 0; }
    .section p { margin:0 0 12px 0; font-size:13px; color:#6b7280; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:12px; border-bottom:1px solid #e5e7eb; text-align:left; }
    th { font-size:12px; color:#6b7280; font-weight:600; }

    .user-row.selected { background:#eff6ff; }

    .pill {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border-radius:50%;
      color:#fff;
      font-size:12px;
      font-weight:600;
      margin-right:8px;
    }

    .active-dot {
      width:8px;
      height:8px;
      background:#22c55e;
      border-radius:50%;
      display:inline-block;
      margin-right:6px;
    }

    .matrix th, .matrix td { text-align:center; }
    .matrix th:first-child, .matrix td:first-child { text-align:left; }

    .global-warning {
      display:none;
      background:#fff1f2;
      border-bottom:1px solid #fecdd3;
      color:#9f1239;
      padding:14px 24px;
      font-size:14px;
    }

    .conflict-summary {
      display:none;
      background:#f8fafc;
      border-bottom:1px solid #e5e7eb;
      padding:8px 24px;
      font-size:13px;
      color:#374151;
    }

    .tooltip { position:relative; cursor:help; }
    .tooltip:hover::after {
      width: 180px;
      content: attr(data-tooltip);
      position:absolute;
      bottom:120%;
      left:50%;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
      white-space:pre-line;
      z-index:10;
      max-width:280px;
      line-height:1.4;
    }

    .conflict {
      outline:2px solid #fca5a5;
      outline-offset:2px;
      border-radius:4px;
    }

    .footer {
      padding:16px 24px;
      border-top:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    button {
      border-radius:8px;
      padding:10px 16px;
      font-size:14px;
      border:none;
      cursor:pointer;
    }

    .primary { background:#2563eb; color:#fff; }
    .ghost { background:none; color:#2563eb; }
  </style>
</head>
<body>

<div class="modal">
  <div class="header">
    <h1>Add users</h1>
    ✕
  </div>

  <div id="globalWarning" class="global-warning"></div>
  <div id="conflictSummary" class="conflict-summary"></div>

  <div class="content">

    <div class="section">
      <h2>Users list *</h2>
      <p>Add existing Control Center users as participants.</p>

      <table id="usersTable">
        <thead>
          <tr>
            <th><input id="selectAllUsers" type="checkbox"></th>
            <th>User ID</th>
            <th>Name</th>
            <th id="licHeader" style="user-select:none; position:relative;">
              <span id="licHeaderLabel" style="cursor:pointer;">License</span>
              <button id="licFilterBtn" title="Filter license" style="margin-left:6px; background:none; border:1px solid #e5e7eb; border-radius:4px; padding:2px 4px; cursor:pointer;">
                <svg id="licChevronIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#6b7280" width="12" height="12" style="vertical-align:-1px;">
                  <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 11.108l3.71-3.877a.75.75 0 1 1 1.08 1.04l-4.24 4.433a.75.75 0 0 1-1.08 0L5.21 8.27a.75.75 0 0 1 .02-1.06Z" clip-rule="evenodd"/>
                </svg>
              </button>
              <div id="licFilterMenu" style="display:none; position:absolute; top:24px; left:0; background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:8px; box-shadow:0 10px 20px rgba(0,0,0,.12); z-index:20; min-width:160px;">
                <label style="display:flex; align-items:center; gap:6px; font-size:13px; margin:4px 0;">
                  <input type="checkbox" id="licOptAll" checked>
                  <span>All</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; font-size:13px; margin:4px 0;">
                  <input type="checkbox" class="licOpt" value="basic">
                  <span>Basic</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; font-size:13px; margin:4px 0;">
                  <input type="checkbox" class="licOpt" value="standard">
                  <span>Standard</span>
                </label>
                <label style="display:flex; align-items:center; gap:6px; font-size:13px; margin:4px 0;">
                  <input type="checkbox" class="licOpt" value="changeadmin">
                  <span>Change Admin</span>
                </label>
              </div>
            </th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr data-role="viewer" data-license="basic">
            <td><input type="checkbox"></td>
            <td>EAMINOFF</td>
            <td><span class="pill" style="background:#6366f1">EA</span>Erin Aminoff</td>
            <td><span style="display:inline-block;padding:4px 8px;border-radius:6px;background:#eef2ff;color:#3730a3;font-size:12px;">Basic</span></td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
          <tr data-role="initiator" data-license="standard">
            <td><input type="checkbox"></td>
            <td>EMERSON</td>
            <td><span class="pill" style="background:#0ea5e9">EH</span>Emerson Herwitz</td>
            <td><span style="display:inline-block;padding:4px 8px;border-radius:6px;background:#ecfeff;color:#155e75;font-size:12px;">Standard</span></td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
          <tr data-role="reviewer" data-license="standard">
            <td><input type="checkbox"></td>
            <td>JBAPTISTA</td>
            <td><span class="pill" style="background:#4f46e5">JB</span>Jaydon Baptista</td>
            <td><span style="display:inline-block;padding:4px 8px;border-radius:6px;background:#ecfeff;color:#155e75;font-size:12px;">Standard</span></td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
          <tr data-role="approver" data-license="changeAdmin">
            <td><input type="checkbox"></td>
            <td>KLEE</td>
            <td><span class="pill" style="background:#10b981">KL</span>Kai Lee</td>
            <td><span style="display:inline-block;padding:4px 8px;border-radius:6px;background:#f0fdf4;color:#166534;font-size:12px;">Change&nbsp;Admin</span></td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
          <tr data-role="full" data-license="changeAdmin">
            <td><input type="checkbox"></td>
            <td>MRODRIGUEZ</td>
            <td><span class="pill" style="background:#a855f7">MR</span>Marisol Rodriguez</td>
            <td><span style="display:inline-block;padding:4px 8px;border-radius:6px;background:#f0fdf4;color:#166534;font-size:12px;">Change&nbsp;Admin</span></td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>Enterprise permissions (Global) *</h2>
      <p>Set enterprise permissions for all task types.</p>

      <table class="matrix" id="permissionMatrix">
        <thead>
          <tr>
            <th>Task type</th>
            <th>No access</th>
            <th>Initiator</th>
            <th>Viewer</th>
            <th>Reviewer</th>
            <th>Approver</th>
            <th>Full access</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Trend</td>
            <td><input type="checkbox" data-perm="none"></td>
            <td><input type="checkbox" data-perm="initiator"></td>
            <td><input type="checkbox" data-perm="viewer"></td>
            <td><input type="checkbox" data-perm="reviewer"></td>
            <td><input type="checkbox" data-perm="approver"></td>
            <td><input type="checkbox" data-perm="full"></td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <div class="footer">
    <button class="ghost">Cancel</button>
    <button class="primary">Next</button>
  </div>
</div>

<!-- (License editing UI removed per rollback) -->

<script>
  const roleOrder = ['viewer','initiator','reviewer','approver','full'];
  const userRows = document.querySelectorAll('#usersTable tbody tr');
  const permCheckboxes = document.querySelectorAll('#permissionMatrix input');
  const warning = document.getElementById('globalWarning');
  const summary = document.getElementById('conflictSummary');
  const selectAllUsersCb = document.getElementById('selectAllUsers');
  const licHeaderLabel = document.getElementById('licHeaderLabel');
  const licFilterBtn = document.getElementById('licFilterBtn');
  const licFilterMenu = document.getElementById('licFilterMenu');
  const licOptAll = document.getElementById('licOptAll');

  const truncateName = (name, max=14) =>
    name.length <= max ? name : `${name.slice(0,5)}…${name.slice(-3)}`;

  function selectedUsers() {
    return [...userRows]
      .filter(r => r.querySelector('input').checked)
      .map(r => {
        const nameCell = r.children[2];
        // Use only the text nodes in the cell (exclude the initials pill span)
        const plainName = [...nameCell.childNodes]
          .filter(n => n.nodeType === Node.TEXT_NODE)
          .map(n => n.textContent)
          .join('')
          .trim();
        return { name: plainName, role: r.dataset.role };
      });
  }

  function validatePermissions() {
    const users = selectedUsers();
    const perms = [...permCheckboxes].filter(c => c.checked).map(c => c.dataset.perm);
    const granular = ['initiator','viewer','reviewer','approver'];
    const allGranularChecked = granular.every(p => perms.includes(p));
    // If all granular are selected, treat "full" as redundant for conflict checks
    const permsToCheck = allGranularChecked ? perms.filter(p => p !== 'full') : perms;
    let conflicts = [];

    // If user selects permissions first, prompt to select users
    if (!users.length && permsToCheck.length) {
      warning.style.display = 'block';
      warning.innerText = 'ℹ️ Select users to apply permissions.';
      summary.style.display = 'none';
      return;
    }

    // If multiple users with different roles/permissions are selected, show a top warning
    const uniqueRoles = Array.from(new Set(users.map(u => u.role)));
    if (users.length > 1 && uniqueRoles.length > 1) {
      warning.style.display = 'block';
      warning.innerText = '⚠️ Selected users have different roles. Applying the same permission may cause conflicts.';
      summary.style.display = 'none';
      // Disable permission controls until the selection is resolved
      permCheckboxes.forEach(cb => {
        cb.disabled = true;
        cb.classList.add('tooltip');
        cb.setAttribute('data-tooltip', 'Resolve selection: choose users with the same role or unselect users to enable permissions.');
      });
      return;
    }

    permsToCheck.forEach(p =>
      users.forEach(u => {
        if (roleOrder.indexOf(p) > roleOrder.indexOf(u.role)) {
          conflicts.push({ user:u, perm:p });
        }
      })
    );

    permCheckboxes.forEach(cb => {
      cb.disabled = false;
      cb.classList.remove('conflict','tooltip');
      cb.removeAttribute('data-tooltip');
    });

    // Full access tooltip/disable: compute hypothetically for selected users
    const fullPerm = [...permCheckboxes].find(cb => cb.dataset.perm === 'full');
    if (fullPerm) {
      const fullConflictUsers = users.filter(u => roleOrder.indexOf('full') > roleOrder.indexOf(u.role)).map(u => u.name);
      // Reset any prior tooltip styles
      fullPerm.classList.remove('conflict','tooltip');
      fullPerm.removeAttribute('data-tooltip');
      fullPerm.disabled = false;
      if (fullConflictUsers.length > 0) {
        fullPerm.checked = false;
        fullPerm.disabled = true;
        fullPerm.classList.add('conflict','tooltip');
        fullPerm.setAttribute(
          'data-tooltip',
          'Not allowed for:\n' + fullConflictUsers.map(n => `• ${truncateName(n)}`).join('\n') + '\n\nConsider upgrading their role.'
        );
      }
    }

    const conflictedPerms = [...new Set(conflicts.map(c => c.perm))];
    const conflictedUsers = [...new Set(conflicts.map(c => c.user.name))];

    if (!conflicts.length) {
      // If we already showed role mismatch warning above, keep it; otherwise clear banner
      if (!(users.length > 1 && uniqueRoles.length > 1)) {
        warning.style.display = summary.style.display = 'none';
      }
      updateSelectAllState();
      return;
    }
    warning.style.display = summary.style.display = 'block';
    warning.innerText = '⚠️ Permission conflict detected. Some permissions were removed.';
    summary.innerHTML =
      `Blocked by: <strong>${conflictedUsers.join(', ')}</strong> · ` +
      `Permissions: <strong>${conflictedPerms.join(', ')}</strong>`;

    permCheckboxes.forEach(cb => {
      if (conflictedPerms.includes(cb.dataset.perm)) {
        const blocked = users.filter(
          u => roleOrder.indexOf(cb.dataset.perm) > roleOrder.indexOf(u.role)
        );
        cb.checked = false;
        cb.disabled = true;
        cb.classList.add('conflict','tooltip');
        cb.setAttribute(
          'data-tooltip',
          'Not allowed for:\n' +
          blocked.map(b => `• ${truncateName(b.name)}`).join('\n') +
          '\n\nConsider upgrading their role.'
        );
      }
    });

    // Keep "Full access" in sync with granular permissions:
    // - Checked only when all granular are checked
    // - Unchecked if any granular is unchecked
    const granularPerms = ['initiator','viewer','reviewer','approver'];
    const fullCbSync = [...permCheckboxes].find(c => c.dataset.perm === 'full');
    const allGranularNowChecked = granularPerms.every(p => {
      const el = [...permCheckboxes].find(c => c.dataset.perm === p);
      return !!(el && el.checked);
    });
    if (fullCbSync) {
      if (allGranularNowChecked && !fullCbSync.disabled) {
        fullCbSync.checked = true;
      } else {
        fullCbSync.checked = false;
      }
    }
  }

  userRows.forEach(row => {
    const cb = row.querySelector('input');
    cb.addEventListener('change', () => {
      row.classList.toggle('selected', cb.checked);
      validatePermissions();
      updateSelectAllState();
    });
  });

  permCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      const rowCbs = [...cb.closest('tr').querySelectorAll('input[data-perm]')];
      const perm = cb.dataset.perm;

      if (perm === 'none' && cb.checked)
        rowCbs.forEach(c => c.dataset.perm !== 'none' && (c.checked=false));

      if (perm !== 'none' && cb.checked)
        rowCbs.find(c => c.dataset.perm === 'none').checked = false;

      if (perm === 'full' && cb.checked)
        rowCbs.forEach(c => c.dataset.perm !== 'none' && (c.checked=true));

      if (perm === 'full' && !cb.checked)
        rowCbs.forEach(c => c.checked=false);

      const granular = ['initiator','viewer','reviewer','approver'];
      const fullCb = rowCbs.find(c => c.dataset.perm === 'full');
      const allGranularChecked = granular.every(p => rowCbs.find(c => c.dataset.perm===p).checked);
      if (allGranularChecked) {
        fullCb.checked = true;
      } else {
        // If any granular permission is unchecked, Full access must be unchecked
        fullCb.checked = false;
      }

      validatePermissions();
    });
  });

  // License filter dropdown behavior
  (function wireLicenseFilter(){
    if (!licFilterBtn || !licFilterMenu) return;
    let selectedSet = new Set(); // empty = All
    const licOpts = [...document.querySelectorAll('.licOpt')];
    const totalOpts = licOpts.length;
    function applyFilter() {
      const rows = [...document.querySelectorAll('#usersTable tbody tr')];
      const isAll = (licOptAll && licOptAll.checked) || selectedSet.size === totalOpts;
      rows.forEach(row => {
        const lic = (row.dataset.license || '').toLowerCase();
        const visible = isAll ? true : (selectedSet.size > 0 ? selectedSet.has(lic) : false);
        row.style.display = visible ? '' : 'none';
      });
      // Update header label suffix
      const labelBase = 'License';
      if (isAll) {
        licHeaderLabel.textContent = `${labelBase} (All)`;
        if (licOptAll) {
          licOptAll.checked = true;
          licOptAll.indeterminate = false;
        }
      } else {
        const order = ['basic','standard','changeadmin'];
        const pretty = { basic:'Basic', standard:'Standard', changeadmin:'Change Admin' };
        const list = order.filter(o => selectedSet.has(o)).map(o => pretty[o]);
        licHeaderLabel.textContent = list.length ? `${labelBase} (${list.join(', ')})` : `${labelBase} (None)`;
        if (licOptAll) {
          // If partial selection, reflect via indeterminate
          licOptAll.checked = selectedSet.size === totalOpts;
          licOptAll.indeterminate = selectedSet.size > 0 && selectedSet.size < totalOpts;
        }
      }
    }
    function closeMenu() { licFilterMenu.style.display = 'none'; }
    licFilterBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      licFilterMenu.style.display = licFilterMenu.style.display === 'none' ? 'block' : 'none';
    });
    document.addEventListener('click', (e) => {
      if (!licFilterMenu.contains(e.target) && e.target !== licFilterBtn) closeMenu();
    });
    licOptAll?.addEventListener('change', () => {
      // Copy user-table select-all logic: All toggles all specific options
      if (licOptAll.checked) {
        licOpts.forEach(i => i.checked = true);
        selectedSet = new Set(licOpts.map(i => (i.value || '').toLowerCase()));
        licOptAll.indeterminate = false;
      } else {
        licOpts.forEach(i => i.checked = false);
        selectedSet.clear();
        licOptAll.indeterminate = false;
      }
      applyFilter();
    });
    licOpts.forEach(i => {
      i.addEventListener('change', () => {
        // rebuild selected set from current checkboxes
        selectedSet = new Set(licOpts.filter(x => x.checked).map(x => (x.value || '').toLowerCase()));
      // Update All checkbox to mirror user-table logic
      licOptAll.checked = selectedSet.size === totalOpts;
      licOptAll.indeterminate = selectedSet.size > 0 && selectedSet.size < totalOpts;
        applyFilter();
      });
    });
    applyFilter();
  })();

  // License column sort
  (function wireLicenseSort(){
    const header = document.getElementById('licHeader');
    const icon = document.getElementById('licSortIcon');
    if (!header || !icon) return;
    let asc = true;
    const licOrder = { 'basic':0, 'standard':1, 'changeadmin':2 };
    header.addEventListener('click', () => {
      const tbody = document.querySelector('#usersTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a,b) => {
        const la = (a.dataset.license || '').toLowerCase();
        const lb = (b.dataset.license || '').toLowerCase();
        const av = licOrder.hasOwnProperty(la) ? licOrder[la] : 99;
        const bv = licOrder.hasOwnProperty(lb) ? licOrder[lb] : 99;
        return asc ? (av - bv) : (bv - av);
      });
      rows.forEach(r => tbody.appendChild(r));
      icon.style.transform = asc ? 'rotate(180deg)' : 'rotate(0deg)';
      asc = !asc;
    });
  })();

  // Select-all master checkbox
  function updateSelectAllState() {
    if (!selectAllUsersCb) return;
    const rowCbs = [...document.querySelectorAll('#usersTable tbody input[type="checkbox"]')];
    const enabled = rowCbs.filter(i => !i.disabled);
    const checkedEnabled = enabled.filter(i => i.checked);
    if (enabled.length === 0) {
      selectAllUsersCb.indeterminate = false;
      selectAllUsersCb.checked = false;
      return;
    }
    selectAllUsersCb.indeterminate = checkedEnabled.length > 0 && checkedEnabled.length < enabled.length;
    selectAllUsersCb.checked = checkedEnabled.length === enabled.length;
  }
  if (selectAllUsersCb) {
    selectAllUsersCb.addEventListener('change', () => {
      const shouldCheck = !!selectAllUsersCb.checked;
      document.querySelectorAll('#usersTable tbody tr').forEach(row => {
        const cb = row.querySelector('input[type="checkbox"]');
        if (!cb) return;
        if (cb.disabled && shouldCheck) return;
        cb.checked = shouldCheck && !cb.disabled;
        row.classList.toggle('selected', cb.checked);
      });
      validatePermissions();
      updateSelectAllState();
    });
  }
  // initialize
  updateSelectAllState();
</script>

</body>
</html>

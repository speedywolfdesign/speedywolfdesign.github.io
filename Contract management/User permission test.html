<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Add Users – Enterprise Permissions Demo</title>
  <style>
    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:#f5f6f8;
      margin:0;
      padding:24px;
      color:#111827;
    }

    .modal {
      max-width:1100px;
      margin:auto;
      background:#fff;
      border-radius:10px;
      box-shadow:0 20px 40px rgba(0,0,0,.12);
      overflow:hidden;
      height: calc(100vh - 50px);
      display:flex;
      flex-direction:column;
    }

    .header {
      padding:20px 24px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    h1 { font-size:20px; margin:0; }
    .content { padding:24px; flex: 1 1 auto; overflow: auto; min-height: 0; }
    .section { margin-bottom:28px; }

    .section h2 { font-size:16px; margin:0 0 4px 0; }
    .section p { margin:0 0 12px 0; font-size:13px; color:#6b7280; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { padding:12px; border-bottom:1px solid #e5e7eb; text-align:left; }
    th { font-size:12px; color:#6b7280; font-weight:600; }

    .user-row.selected { background:#eff6ff; }

    .pill {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border-radius:50%;
      color:#fff;
      font-size:12px;
      font-weight:600;
      margin-right:8px;
    }

    .active-dot {
      width:8px;
      height:8px;
      background:#22c55e;
      border-radius:50%;
      display:inline-block;
      margin-right:6px;
    }

    .matrix th, .matrix td { text-align:center; }
    .matrix th:first-child, .matrix td:first-child { text-align:left; }

    .global-warning {
      display:none;
      background:#fff1f2;
      border-bottom:1px solid #fecdd3;
      color:#9f1239;
      padding:14px 24px;
      font-size:14px;
    }

    .conflict-summary {
      display:none;
      background:#f8fafc;
      border-bottom:1px solid #e5e7eb;
      padding:8px 24px;
      font-size:13px;
      color:#374151;
    }

    .tooltip { position:relative; cursor:help; }
    .tooltip:hover::after {
      width: 180px;
      content: attr(data-tooltip);
      position:absolute;
      bottom:120%;
      left:50%;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:8px 10px;
      border-radius:6px;
      font-size:12px;
      white-space:pre-line;
      z-index:10;
      max-width:280px;
      line-height:1.4;
    }

    .conflict {
      outline:2px solid #fca5a5;
      outline-offset:2px;
      border-radius:4px;
    }

    .footer {
      padding:16px 24px;
      border-top:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    button {
      border-radius:8px;
      padding:10px 16px;
      font-size:14px;
      border:none;
      cursor:pointer;
    }

    .primary { background:#2563eb; color:#fff; }
    .ghost { background:none; color:#2563eb; }
  </style>
</head>
<body>

<div class="modal">
  <div class="header">
    <h1>Add users</h1>
    ✕
  </div>

  <div id="globalWarning" class="global-warning"></div>
  <div id="conflictSummary" class="conflict-summary"></div>

  <div class="content">

    <div class="section">
      <h2>Users list *</h2>
      <p>Add existing Control Center users as participants.</p>

      <table id="usersTable">
        <thead>
          <tr>
            <th></th>
            <th>User ID</th>
            <th>Name</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr data-role="viewer">
            <td><input type="checkbox"></td>
            <td>EAMINOFF</td>
            <td><span class="pill" style="background:#6366f1">EA</span>Erin Aminoff</td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
          <tr data-role="initiator">
            <td><input type="checkbox"></td>
            <td>EMERSON</td>
            <td><span class="pill" style="background:#0ea5e9">EH</span>Emerson Herwitz</td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
          <tr data-role="reviewer">
            <td><input type="checkbox"></td>
            <td>JBAPTISTA</td>
            <td><span class="pill" style="background:#4f46e5">JB</span>Jaydon Baptista</td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
          <tr data-role="approver">
            <td><input type="checkbox"></td>
            <td>KLEE</td>
            <td><span class="pill" style="background:#10b981">KL</span>Kai Lee</td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
          <tr data-role="full">
            <td><input type="checkbox"></td>
            <td>MRODRIGUEZ</td>
            <td><span class="pill" style="background:#a855f7">MR</span>Marisol Rodriguez</td>
            <td><span class="active-dot"></span>Active</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="section">
      <h2>Enterprise permissions (Global) *</h2>
      <p>Set enterprise permissions for all task types.</p>

      <table class="matrix" id="permissionMatrix">
        <thead>
          <tr>
            <th>Task type</th>
            <th>No access</th>
            <th>Initiator</th>
            <th>Viewer</th>
            <th>Reviewer</th>
            <th>Approver</th>
            <th>Full access</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Trend</td>
            <td><input type="checkbox" data-perm="none"></td>
            <td><input type="checkbox" data-perm="initiator"></td>
            <td><input type="checkbox" data-perm="viewer"></td>
            <td><input type="checkbox" data-perm="reviewer"></td>
            <td><input type="checkbox" data-perm="approver"></td>
            <td><input type="checkbox" data-perm="full"></td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <div class="footer">
    <button class="ghost">Cancel</button>
    <button class="primary">Next</button>
  </div>
</div>

<script>
  const roleOrder = ['viewer','initiator','reviewer','approver','full'];
  const userRows = document.querySelectorAll('#usersTable tbody tr');
  const permCheckboxes = document.querySelectorAll('#permissionMatrix input');
  const warning = document.getElementById('globalWarning');
  const summary = document.getElementById('conflictSummary');

  const truncateName = (name, max=14) =>
    name.length <= max ? name : `${name.slice(0,5)}…${name.slice(-3)}`;

  function selectedUsers() {
    return [...userRows]
      .filter(r => r.querySelector('input').checked)
      .map(r => ({ name: r.children[2].innerText.trim(), role: r.dataset.role }));
  }

  function validatePermissions() {
    const users = selectedUsers();
    const perms = [...permCheckboxes].filter(c => c.checked).map(c => c.dataset.perm);
    const granular = ['initiator','viewer','reviewer','approver'];
    const allGranularChecked = granular.every(p => perms.includes(p));
    // If all granular are selected, treat "full" as redundant for conflict checks
    const permsToCheck = allGranularChecked ? perms.filter(p => p !== 'full') : perms;
    let conflicts = [];

    permsToCheck.forEach(p =>
      users.forEach(u => {
        if (roleOrder.indexOf(p) > roleOrder.indexOf(u.role)) {
          conflicts.push({ user:u, perm:p });
        }
      })
    );

    permCheckboxes.forEach(cb => {
      cb.disabled = false;
      cb.classList.remove('conflict','tooltip');
      cb.removeAttribute('data-tooltip');
    });

    if (!conflicts.length) {
      warning.style.display = summary.style.display = 'none';
      return;
    }

    // When any conflicts exist, Full access cannot be checked; include conflicting user names
    const fullPerm = [...permCheckboxes].find(cb => cb.dataset.perm === 'full');
    if (fullPerm) {
      const conflictNames = [...new Set(conflicts.map(c => c.user.name))];
      fullPerm.checked = false;
      fullPerm.disabled = true;
      fullPerm.classList.add('conflict','tooltip');
      fullPerm.setAttribute(
        'data-tooltip',
        `Full access disabled due to conflicts with:\n` + conflictNames.map(n => `• ${n}`).join('\n')
      );
    }

    const conflictedPerms = [...new Set(conflicts.map(c => c.perm))];
    const conflictedUsers = [...new Set(conflicts.map(c => c.user.name))];

    warning.style.display = summary.style.display = 'block';
    warning.innerText = '⚠️ Permission conflict detected. Some permissions were removed.';
    summary.innerHTML =
      `Blocked by: <strong>${conflictedUsers.join(', ')}</strong> · ` +
      `Permissions: <strong>${conflictedPerms.join(', ')}</strong>`;

    permCheckboxes.forEach(cb => {
      if (conflictedPerms.includes(cb.dataset.perm)) {
        const blocked = users.filter(
          u => roleOrder.indexOf(cb.dataset.perm) > roleOrder.indexOf(u.role)
        );
        cb.checked = false;
        cb.disabled = true;
        cb.classList.add('conflict','tooltip');
        cb.setAttribute(
          'data-tooltip',
          'Not allowed for:\n' +
          blocked.map(b => `• ${truncateName(b.name)}`).join('\n') +
          '\n\nConsider upgrading their role.'
        );
      }
    });
  }

  userRows.forEach(row => {
    const cb = row.querySelector('input');
    cb.addEventListener('change', () => {
      row.classList.toggle('selected', cb.checked);
      validatePermissions();
    });
  });

  permCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      const rowCbs = [...cb.closest('tr').querySelectorAll('input[data-perm]')];
      const perm = cb.dataset.perm;

      if (perm === 'none' && cb.checked)
        rowCbs.forEach(c => c.dataset.perm !== 'none' && (c.checked=false));

      if (perm !== 'none' && cb.checked)
        rowCbs.find(c => c.dataset.perm === 'none').checked = false;

      if (perm === 'full' && cb.checked)
        rowCbs.forEach(c => c.dataset.perm !== 'none' && (c.checked=true));

      if (perm === 'full' && !cb.checked)
        rowCbs.forEach(c => c.checked=false);

      const granular = ['initiator','viewer','reviewer','approver'];
      const fullCb = rowCbs.find(c => c.dataset.perm === 'full');
      const allGranularChecked = granular.every(p => rowCbs.find(c => c.dataset.perm===p).checked);
      if (allGranularChecked) {
        fullCb.checked = true;
      } else {
        // If any granular permission is unchecked, Full access must be unchecked
        fullCb.checked = false;
      }

      validatePermissions();
    });
  });
</script>

</body>
</html>
